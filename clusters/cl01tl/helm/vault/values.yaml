vault:
  global:
    enabled: true
    tlsDisable: true
    psp:
      enable: false
    serverTelemetry:
      prometheusOperator: true
  injector:
    enabled: false
  server:
    enabled: true
    image:
      repository: hashicorp/vault
      tag: 1.21.1
    updateStrategyType: "RollingUpdate"
    logLevel: debug
    logFormat: standard
    resources:
      requests:
        cpu: 50m
        memory: 512Mi
    ingress:
      enabled: false
    route:
      enabled: false
    authDelegator:
      enabled: false
    readinessProbe:
      enabled: true
      port: 8200
    livenessProbe:
      enabled: false
    volumes:
      - name: vault-storage-backup
        persistentVolumeClaim:
          claimName: vault-storage-backup
    volumeMounts:
      - mountPath: /opt/backups/
        name: vault-storage-backup
        readOnly: false
    affinity: |
      podAntiAffinity:
        requiredDuringSchedulingIgnoredDuringExecution:
          - labelSelector:
              matchLabels:
                app.kubernetes.io/name: {{ template "vault.name" . }}
                app.kubernetes.io/instance: "{{ .Release.Name }}"
                component: server
            topologyKey: kubernetes.io/hostname
    networkPolicy:
      enabled: false
    service:
      enabled: true
      active:
        enabled: true
      standby:
        enabled: false
      type: ClusterIP
      port: 8200
      targetPort: 8200
    dataStorage:
      enabled: true
      size: 1Gi
      mountPath: "/vault/data"
      accessMode: ReadWriteOnce
    auditStorage:
      enabled: false
      size: 5Gi
      mountPath: "/vault/audit"
      accessMode: ReadWriteOnce
    dev:
      enabled: false
    standalone:
      enabled: false
    ha:
      enabled: true
      replicas: 3
      raft:
        enabled: true
        config: |
          ui = true

          listener "tcp" {
            tls_disable = 1
            address = "[::]:8200"
            cluster_address = "[::]:8201"
            telemetry {
              unauthenticated_metrics_access = "true"
            }
          }

          storage "raft" {
            path = "/vault/data"
            retry_join {
              leader_api_addr = "http://vault-0.vault-internal:8200"
            }
            retry_join {
              leader_api_addr = "http://vault-1.vault-internal:8200"
            }
            retry_join {
              leader_api_addr = "http://vault-2.vault-internal:8200"
            }
          }

          service_registration "kubernetes" {}

          telemetry {
            prometheus_retention_time = "30s"
            disable_hostname = true
          }

      disruptionBudget:
        enabled: true
        maxUnavailable: null
    serviceAccount:
      create: true
      serviceDiscovery:
        enabled: true
    hostNetwork: false
  ui:
    enabled: true
    publishNotReadyAddresses: true
    activeVaultPodOnly: false
    serviceType: "ClusterIP"
    serviceNodePort: null
    externalPort: 8200
    targetPort: 8200
  csi:
    enabled: false
  serverTelemetry:
    serviceMonitor:
      enabled: true
      interval: 30s
      scrapeTimeout: 10s
    prometheusRules:
      enabled: true
      rules:
        - alert: vault-HighResponseTime
          annotations:
            message: The response time of Vault is over 500ms on average over the last 5 minutes.
          expr: vault_core_handle_request{quantile="0.5", namespace="mynamespace"} > 500
          for: 5m
          labels:
            severity: warning
        - alert: vault-HighResponseTime
          annotations:
            message: The response time of Vault is over 1s on average over the last 5 minutes.
          expr: vault_core_handle_request{quantile="0.5", namespace="mynamespace"} > 1000
          for: 5m
          labels:
            severity: critical
snapshot:
  global:
    fullnameOverride: vault-snapshot
  controllers:
    snapshot:
      type: cronjob
      pod:
        securityContext:
          runAsUser: 100
          runAsGroup: 1000
      cronjob:
        suspend: false
        concurrencyPolicy: Forbid
        timeZone: US/Central
        schedule: 0 4 * * *
        startingDeadlineSeconds: 90
        successfulJobsHistory: 1
        failedJobsHistory: 3
        backoffLimit: 3
        parallelism: 1
      initContainers:
        snapshot:
          image:
            repository: hashicorp/vault
            tag: 1.21.1
            pullPolicy: IfNotPresent
          command:
            - /bin/ash
          args:
            - -ec
            - /scripts/snapshot.sh
          envFrom:
            - secretRef:
                name: vault-snapshot-agent-token
          env:
            - name: VAULT_ADDR
              value: http://vault-active.vault.svc.cluster.local:8200
      containers:
        s3-backup-local:
          image:
            repository: d3fk/s3cmd
            tag: latest@sha256:ed348a0fae5723d2e62636c175baf4dfaf732a790179ca675d1f24f863d0d68f
            pullPolicy: IfNotPresent
          command:
            - /bin/sh
          args:
            - -ec
            - /scripts/backup.sh
          env:
            - name: BUCKET
              valueFrom:
                secretKeyRef:
                  name: vault-s3cmd-local-config
                  key: BUCKET
        s3-backup-remote:
          image:
            repository: d3fk/s3cmd
            tag: latest@sha256:ed348a0fae5723d2e62636c175baf4dfaf732a790179ca675d1f24f863d0d68f
            pullPolicy: IfNotPresent
          command:
            - /bin/sh
          args:
            - -ec
            - /scripts/backup.sh
          env:
            - name: BUCKET
              valueFrom:
                secretKeyRef:
                  name: vault-s3cmd-remote-config
                  key: BUCKET
        s3-backup-external:
          image:
            repository: d3fk/s3cmd
            tag: latest@sha256:ed348a0fae5723d2e62636c175baf4dfaf732a790179ca675d1f24f863d0d68f
            pullPolicy: IfNotPresent
          command:
            - /bin/sh
          args:
            - -ec
            - /scripts/backup.sh
          env:
            - name: BUCKET
              valueFrom:
                secretKeyRef:
                  name: vault-s3cmd-external-config
                  key: BUCKET
  persistence:
    snapshot-script:
      enabled: true
      type: configMap
      name: vault-snapshot-script
      defaultMode: 0755
      advancedMounts:
        snapshot:
          snapshot:
            - path: /scripts/snapshot.sh
              subPath: snapshot.sh
    backup-script:
      enabled: true
      type: configMap
      name: vault-backup-script
      defaultMode: 0755
      advancedMounts:
        snapshot:
          s3-backup-local:
            - path: /scripts/backup.sh
              subPath: backup.sh
          s3-backup-remote:
            - path: /scripts/backup.sh
              subPath: backup.sh
          s3-backup-external:
            - path: /scripts/backup.sh
              subPath: backup.sh
    s3cmd-local-config:
      enabled: true
      type: secret
      name: vault-s3cmd-local-config
      advancedMounts:
        snapshot:
          s3-backup-local:
            - path: /root/.s3cfg
              readOnly: true
              mountPropagation: None
              subPath: .s3cfg
    s3cmd-remote-config:
      enabled: true
      type: secret
      name: vault-s3cmd-remote-config
      advancedMounts:
        snapshot:
          s3-backup-remote:
            - path: /root/.s3cfg
              readOnly: true
              mountPropagation: None
              subPath: .s3cfg
    s3cmd-external-config:
      enabled: true
      type: secret
      name: vault-s3cmd-external-config
      advancedMounts:
        snapshot:
          s3-backup-external:
            - path: /root/.s3cfg
              readOnly: true
              mountPropagation: None
              subPath: .s3cfg
    backup:
      existingClaim: vault-storage-backup
      advancedMounts:
        snapshot:
          snapshot:
            - path: /opt/backup
              readOnly: false
          s3-backup-local:
            - path: /opt/backup
              readOnly: false
          s3-backup-remote:
            - path: /opt/backup
              readOnly: false
          s3-backup-external:
            - path: /opt/backup
              readOnly: false
unseal:
  global:
    fullnameOverride: vault-unseal
  controllers:
    unseal-1:
      type: deployment
      replicas: 1
      strategy: Recreate
      revisionHistoryLimit: 3
      containers:
        main:
          image:
            repository: ghcr.io/lrstanley/vault-unseal
            tag: 0.7.2
            pullPolicy: IfNotPresent
          envFrom:
            - secretRef:
                name: vault-unseal-config-1
          resources:
            requests:
              cpu: 10m
              memory: 24Mi
    unseal-2:
      type: deployment
      replicas: 1
      strategy: Recreate
      revisionHistoryLimit: 3
      containers:
        main:
          image:
            repository: ghcr.io/lrstanley/vault-unseal
            tag: 0.7.2
            pullPolicy: IfNotPresent
          envFrom:
            - secretRef:
                name: vault-unseal-config-2
          resources:
            requests:
              cpu: 10m
              memory: 24Mi
    unseal-3:
      type: deployment
      replicas: 1
      strategy: Recreate
      revisionHistoryLimit: 3
      containers:
        main:
          image:
            repository: ghcr.io/lrstanley/vault-unseal
            tag: 0.7.2
            pullPolicy: IfNotPresent
          envFrom:
            - secretRef:
                name: vault-unseal-config-3
          resources:
            requests:
              cpu: 10m
              memory: 24Mi
temp:
  controllers:
    main:
      type: deployment
      replicas: 1
      strategy: Recreate
      containers:
        main:
          image:
            repository: ubuntu
            tag: resolute-20251208
            pullPolicy: IfNotPresent
          command:
            - "sleep"
            - "infinity"
          resources:
            requests:
              cpu: 10m
              memory: 32Mi
  persistence:
    backup:
      existingClaim: vault-storage-backup
      advancedMounts:
        main:
          main:
            - path: /opt/backup
              readOnly: false
    backup-old:
      existingClaim: vault-nfs-storage-backup
      advancedMounts:
        main:
          main:
            - path: /opt/backup-old
              readOnly: false
