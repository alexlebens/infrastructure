booklore:
  controllers:
    main:
      type: deployment
      replicas: 1
      strategy: Recreate
      revisionHistoryLimit: 3
      containers:
        main:
          image:
            repository: ghcr.io/booklore-app/booklore
            tag: v1.15.0
            pullPolicy: IfNotPresent
          env:
            - name: TZ
              value: America/Chicago
            - name: DATABASE_URL
              value: jdbc:mariadb://booklore-mariadb-cluster-primary.booklore:3306/booklore
            - name: DATABASE_USERNAME
              value: booklore
            - name: DATABASE_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: booklore-database-secret
                  key: password
            - name: BOOKLORE_PORT
              value: 6060
            - name: SWAGGER_ENABLED
              value: false
          resources:
            requests:
              cpu: 50m
              memory: 128Mi
  service:
    main:
      controller: main
      ports:
        http:
          port: 80
          targetPort: 6060
          protocol: HTTP
  route:
    main:
      kind: HTTPRoute
      parentRefs:
        - group: gateway.networking.k8s.io
          kind: Gateway
          name: traefik-gateway
          namespace: traefik
      hostnames:
        - booklore.alexlebens.net
      rules:
        - backendRefs:
            - group: ''
              kind: Service
              name: booklore
              port: 80
              weight: 100
          matches:
            - path:
                type: PathPrefix
                value: /
  persistence:
    config:
      forceRename: booklore-config
      storageClass: ceph-block
      accessMode: ReadWriteOnce
      size: 5Gi
      retain: true
      advancedMounts:
        main:
          main:
            - path: /app/data
              readOnly: false
    data:
      forceRename: booklore-data
      storageClass: ceph-block
      accessMode: ReadWriteOnce
      size: 10Gi
      retain: true
      advancedMounts:
        main:
          main:
            - path: /data
              readOnly: false
    books-import:
      type: emptyDir
      advancedMounts:
        main:
          main:
            - path: /bookdrop
              readOnly: false
    ingest:
      existingClaim: booklore-books-import-nfs-storage
      advancedMounts:
        main:
          main:
            - path: /bookdrop/ingest
              readOnly: false
mariadb-cluster:
  mariadb:
    rootPasswordSecretKeyRef:
      generate: false
      name: booklore-database-secret
      key: password
    storage:
      size: 5Gi
    replicas: 3
    galera:
      enabled: true
  databases:
    - name: booklore
      characterSet: utf8
      collate: utf8_general_ci
      cleanupPolicy: Delete
      requeueInterval: 10h
  users:
    - name: booklore
      passwordSecretKeyRef:
        name: booklore-database-secret
        key: password
      host: '%'
      cleanupPolicy: Delete
      requeueInterval: 10h
      retryInterval: 30s
  grants:
    - name: booklore
      privileges:
        - "ALL PRIVILEGES"
      database: "booklore"
      table: "*"
      username: booklore
      grantOption: true
      host: '%'
      cleanupPolicy: Delete
      requeueInterval: 10h
      retryInterval: 30s
  physicalBackups:
    - name: backup-external
      schedule:
        cron: "0 0 * * 0"
        suspend: false
        immediate: true
      compression: gzip
      maxRetention: 2160h
      successfulJobsHistoryLimit: 1
      storage:
        s3:
          bucket: mariadb-backups-b230a2f5aecf080a4b372c08
          prefix: cl01tl/booklore
          endpoint: nyc3.digitaloceanspaces.com
          region: us-east-1
          accessKeyIdSecretKeyRef:
            name: booklore-mariadb-cluster-backup-secret-external
            key: access
          secretAccessKeySecretKeyRef:
            name: booklore-mariadb-cluster-backup-secret-external
            key: secret
          tls:
            enabled: true
    - name: backup-remote
      schedule:
        cron: "0 0 * * 0"
        suspend: false
        immediate: true
      compression: gzip
      maxRetention: 2160h
      successfulJobsHistoryLimit: 1
      storage:
        s3:
          bucket: mariadb-backups
          prefix: cl01tl/booklore
          endpoint: garage-ps10rp.boreal-beaufort.ts.net:3900
          region: us-east-1
          accessKeyIdSecretKeyRef:
            name: booklore-mariadb-cluster-backup-secret-garage
            key: access
          secretAccessKeySecretKeyRef:
            name: booklore-mariadb-cluster-backup-secret-garage
            key: secret
          tls:
            enabled: true
    - name: backup-garage
      schedule:
        cron: "0 0 * * *"
        suspend: false
        immediate: true
      compression: gzip
      maxRetention: 360h
      successfulJobsHistoryLimit: 1
      storage:
        s3:
          bucket: mariadb-backups
          prefix: cl01tl/booklore
          endpoint: garage-main.garage:3900
          region: us-east-1
          accessKeyIdSecretKeyRef:
            name: booklore-mariadb-cluster-backup-secret-garage
            key: access
          secretAccessKeySecretKeyRef:
            name: booklore-mariadb-cluster-backup-secret-garage
            key: secret
volsync-target-config:
  pvcTarget: booklore-config
  local:
    enabled: false
    schedule: 12 8 * * *
  remote:
    enabled: false
  external:
    enabled: true
    schedule: 12 9 * * *
volsync-target-data:
  pvcTarget: booklore-data
  local:
    enabled: false
    schedule: 14 8 * * *
    restic:
      cacheCapacity: 10Gi
  remote:
    enabled: true
    schedule: 14 10 * * *
    restic:
      cacheCapacity: 10Gi
  external:
    enabled: true
    schedule: 14 9 * * *
    restic:
      cacheCapacity: 10Gi
