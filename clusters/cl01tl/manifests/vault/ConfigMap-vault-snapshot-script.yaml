apiVersion: v1
kind: ConfigMap
metadata:
  name: vault-snapshot-script
  namespace: vault
  labels:
    app.kubernetes.io/name: vault-snapshot-script
    app.kubernetes.io/instance: vault
    app.kubernetes.io/part-of: vault
data:
  update.sh: |
    BACKUP_FOLDER=/opt/backup
    BACKUP_FILE=$(ls -t $BACKUP_FOLDER | head -n 1)

    echo " ";
    echo ">> Running S3 backup for Vault snapshot";

    if s3cmd put --no-check-md5 --no-check-certificate -v "$BACKUP_FOLDER/$BACKUP_FILE" "${BUCKET}/cl01tl/cl01tl-vault-snapshots/$BACKUP_FILE"; then
        echo ">> Upload succeeded"
    else
        echo ">> ERROR: Upload failed"
    fi
