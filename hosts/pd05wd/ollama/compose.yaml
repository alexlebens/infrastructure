---
services:
    tailscale-ollama:
        image: ghcr.io/tailscale/tailscale:latest
        container_name: tailscale-ollama
        cap_add:
            - net_admin
            - sys_module
        environment:
            - TS_STATE_DIR=/var/lib/tailscale
            - TS_ENABLE_METRICS=true
            - TS_HOSTNAME=ollama-pd05wd
        env_file:
            - .ts-env
        network_mode: service:ollama
        restart: always
        volumes:
            - tailscale:/var/lib/tailscale
        devices:
            - /dev/net/tun:/dev/net/tun

    ollama:
        image: ollama/ollama:latest
        container_name: ollama
        environment:
            - OLLAMA_KEEP_ALIVE=24h
        restart: always
        deploy:
            resources:
                reservations:
                    devices:
                        - driver: nvidia
                          capabilities: ["gpu"]
                          count: all
        volumes:
            - ollama:/root/.ollama

volumes:
    tailscale:
    ollama:
